// Header: CLOCK
// File Name: clock.c
// Author: Mustafa Aslan
// Date: 29.10.2015

#include "clock.h"

extern RTC_HandleTypeDef hrtc;
extern RTC_TimeTypeDef Time;
extern RTC_DateTypeDef Date;
extern uint8_t Theme;
extern void Battery_Read(void);
extern void Battery_Icon(uint8_t x_address, uint8_t y_address);
extern void Alarm_Icon(uint8_t x_address, uint8_t y_address);
extern void Bluetooth_Icon(uint8_t x_address, uint8_t y_address);
extern void Vibration_Icon(uint8_t x_address, uint8_t y_address);
extern uint8_t Vib_On_Off;
extern uint8_t Alarm_Status;
extern int8_t alarm_hour;
extern int8_t alarm_min;
extern int8_t min_first_number, min_second_number; 
extern int8_t hour_first_number, hour_second_number;

	// Digital saat gorunumunde rakarmlarin bitleri.
const unsigned char Clock_Numbers [10][60] = {
{ // 0
0xF8, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0xFF,
0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F},
{ // 1
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0xF8, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F}, 
{ // 2
0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0xC0,
0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x0F, 0x0F, 0x0F,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E},
{ // 3 
0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0xC0,
0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x0E, 0x0E, 0x0E,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F},
{ // 4
0xF8, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0xF8, 0xFF,
0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F},
{ // 5
0xF8, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xFF,
0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x0E, 0x0E, 0x0E,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F},
{ // 6
0xF8, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xFF,
0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF,
0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F},
{ // 7
0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F},
{ // 8
0xF8, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0xFF,
0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F},
{ // 9
0xF8, 0xF8, 0xF8, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0xF8, 0xF8, 0xF8, 0xFF,
0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xFF, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0xFF, 0xFF, 0x0E, 0x0E, 0x0E,
0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x0F, 0x0F} 
};

	// Saat ve dakika arasindaki iki noktanin bitleri.
const unsigned char Clock_Dot [] = {
0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x78, 0x78, 0x78, 0x00, 0x00, 0x00, 
};

const unsigned char Date_Numbers [10][4] = {
{ // 0
0x7F, 0x41, 0x41, 0x7F}, 
{ // 1
0x00, 0x00, 0x00, 0x7F}, 
{ // 2
0x79, 0x49, 0x49, 0x4F},
{ // 3 
0x49, 0x49, 0x49, 0x7F},
{ // 4
0x0F, 0x08, 0x08, 0x7F},
{ // 5
0x4F, 0x49, 0x49, 0x79},
{ // 6
0x7F, 0x49, 0x49, 0x79},
{ // 7
0x01, 0x01, 0x01, 0x7F},
{ // 8
0x7F, 0x49, 0x49, 0x7F},
{ // 9
0x4F, 0x49, 0x49, 0x7F} 
};

const unsigned char Date_Dot [] = {0, 0x40, 0};

void Clock(void){
	Clear_Display();
	HAL_RTC_GetTime(&hrtc, &Time, FORMAT_BIN);
	Write_Clock(Time.Minutes, Time.Hours, Theme);
	HAL_RTC_GetDate(&hrtc, &Date, FORMAT_BIN);
	Write_Date(Date.Date, Date.Month, Date.Year);
	Battery_Icon(67, 0);
	Bluetooth_Icon(53, 0);
	Vibration_Icon(37, 0);
	Alarm_Icon(20, 0);
}

void Write_Clock_Numbers(uint8_t x_address, uint8_t y_address, uint8_t number){
	
	uint8_t first_number, second_number;	
	first_number = number / 10; // Ilk rakam.
	second_number = number % 10; // Ikinci rakam.
	
	Set_Address(x_address, y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[first_number][_15times]);
	}
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[first_number][_15times + 15]);
	}
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[first_number][_15times + 30]);
	}	
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[first_number][_15times + 45]);
	}
	
	y_address -= 3;
	x_address += 18;
	
		Set_Address(x_address, y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[second_number][_15times]);
	}
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[second_number][_15times + 15]);
	}
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[second_number][_15times + 30]);
	}	
	Set_Address(x_address, ++y_address);
	for(uint8_t _15times = 0; _15times < 15; _15times++){
		Write_Data(Clock_Numbers[second_number][_15times + 45]);
	}
}

void Write_Clock(uint32_t minutes, uint32_t hours, uint8_t theme){
		// Tema dijital ise.
	if(theme == DIGITAL){
			
		Write_Clock_Numbers(45, 1, minutes); // Dakikanin rakamlarini ciz.		
		Write_Clock_Numbers(5, 1, hours);	// Saatin rakamlarini ciz.
		
		Set_Address(40, 1);
		for(uint8_t _3times = 0; _3times < 3; _3times++){
			Write_Data(Clock_Dot[_3times]);
		}
		Set_Address(40, 2);
		for(uint8_t _3times = 0; _3times < 3; _3times++){
			Write_Data(Clock_Dot[_3times + 3]);
		}
		Set_Address(40, 3);
		for(uint8_t _3times = 0; _3times < 3; _3times++){
			Write_Data(Clock_Dot[_3times + 6]);
		}	
		Set_Address(40, 4);
		for(uint8_t _3times = 0; _3times < 3; _3times++){
			Write_Data(Clock_Dot[_3times + 9]);
		}	
	}
}

void Write_Date_Numbers(uint8_t x_address, uint8_t y_address, uint8_t number){
	
	uint8_t first_number, second_number;	
	first_number = number / 10; // Ilk rakam.
	second_number = number % 10; // Ikinci rakam.
	
	Set_Address(x_address, y_address);
	for(uint8_t _4times = 0; _4times < 4; _4times++){
		Write_Data(Date_Numbers[first_number][_4times]);
	}

	x_address += 5;
	
		Set_Address(x_address, y_address);
	for(uint8_t _4times = 0; _4times < 4; _4times++){
		Write_Data(Date_Numbers[second_number][_4times]);
	}
}

void Write_Date(uint8_t date_day, uint8_t date_month, uint16_t date_year){
	
	Write_Date_Numbers(25, 5, date_day);
	for(uint8_t _3times = 0; _3times < 3; _3times++){
		Write_Data(Date_Dot[_3times]);
	}	
	Write_Date_Numbers(37, 5, date_month);
	for(uint8_t _3times = 0; _3times < 3; _3times++){
		Write_Data(Date_Dot[_3times]);
	}	
	Write_Date_Numbers(49, 5, date_year);
}


void Clock_Loop(void){
	HAL_RTC_GetTime(&hrtc, &Time, FORMAT_BIN);
	HAL_RTC_GetDate(&hrtc, &Date, FORMAT_BIN);
		// Alarmin dongu icinde konturuolu.
	if(alarm_hour == Time.Hours && alarm_min == Time.Minutes && Alarm_Status == 1){
			Set_Address(3,5);
			Write_String("<<<<ALARM>>>>");
			Alarm_Status = 0;	// Alarm tamamlandi.
				//Titresim aciksa.
			if(Vib_On_Off == 1){
				HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_SET);
				HAL_Delay(5000); // 5 saniye
				HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
			}
			else if(Vib_On_Off == 0){
				HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
			}
			++alarm_min;
	}
		//Alarm bir dakika sonra sifiralanacak ve <<<<<ALARM>>>>> yazisi kalkacak.
	else if(alarm_hour == Time.Hours && alarm_min == Time.Minutes && Alarm_Status == 0){
			Set_Address(3,5);
			Write_String("             "); // <<<<ALARM>>>> yi sil.
			min_first_number = 0;	// Dakikanin ilk rakamini sifirla.
			hour_first_number = 0; // Saat ilk rakamini sifirla.
			min_second_number = 0; // Dakika ikince rakamini sifirla.
			hour_second_number = 0;	// Saatin ikinci rakamini sifirla.
			Alarm_Icon(20, 0); // Alarm iconunu sil.
			Write_Date(Date.Date, Date.Month, Date.Year);
	}	
		// Saniye sifir olduguda yani her bir dakikada ekrandaki saati yeniler.
	if(Time.Seconds == 0){
		Write_Clock(Time.Minutes, Time.Hours, Theme);					
	}
	if(Time.Seconds == 59 && Time.Minutes == 59 && Time.Hours == 23){
		Write_Date(Date.Date, Date.Month, Date.Year);					
	}
		// Her yarim saatte bir batarya kontrolu yapar.
	if(Time.Minutes == 30 && Time.Seconds == 0){
		Battery_Read();	// Batarya ADC degerini oku.
		Battery_Icon(67, 0); // Batarya iconunu yeni degere gore yenile.
	}
	Bluetooth_Icon(53, 0);
}

void Clock_Ok_Button(void){
	if(alarm_hour == Time.Hours && alarm_min == Time.Minutes && Alarm_Status == 0){
		HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); // Titresimi kapat.
		Set_Address(3,5);
		Write_String("             "); // <<<<ALARM>>>> yi sil.
		min_first_number = 0;	// Dakikanin ilk rakamini sifirla.
		hour_first_number = 0; // Saat ilk rakamini sifirla.
		min_second_number = 0; // Dakika ikince rakamini sifirla.
		hour_second_number = 0;	// Saatin ikinci rakamini sifirla.
		Alarm_Icon(20, 0); // Alarm iconunu sil.		
	}
}




// Header: CALL SMS
// File Name: call_sms.c
// Author: Mustafa Aslan
// Date: 7.11.2015

#include "call_sms.h"

extern UART_HandleTypeDef huart1; 
extern uint8_t Language;
extern RTC_TimeTypeDef Time;
extern uint8_t Theme;
extern uint8_t Menu_Clock_Status;
extern uint8_t Menu_Status;
extern uint8_t Menu_Call_Sms_Status;
extern uint8_t Menu_Select_Status;
extern uint8_t Vib_On_Off;
extern void Clock(void);
extern void Battery_Icon(uint8_t x_address, uint8_t y_address);
extern void Bluetooth_Icon(uint8_t x_address, uint8_t y_address);
extern void Vibration_Icon(uint8_t x_address, uint8_t y_address);
extern void Alarm_Icon(uint8_t x_address, uint8_t y_address);

extern void Clock_Loop(void);

unsigned char Bluetooth_Data[50]; // Bluetooth verisinin tutulacagi dizi.

	// Arama ekrani bitleri.
const unsigned char phonecall [] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00,
0x00, 0xE0, 0x00, 0x00, 0x00, 0xFC, 0x04, 0xF4, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
0x14, 0x14, 0x14, 0xF4, 0x04, 0xFC, 0x00, 0x00, 0x00, 0xE0, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00,
0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFE, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00,
0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xFF,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x00, 0xFF, 0x00, 0x00,
0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x7F, 0x00, 0x00,
0x00, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00,
0x00, 0x1F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x16, 0x16, 0x16, 0x10, 0x10, 0x10, 0x10, 0x10,
0x10, 0x1F, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};
	
void Call_Started_Loop(void){
	HAL_UART_Receive(&huart1, (uint8_t *)Bluetooth_Data, 50, 1000);
		// Arama geldiyse.
	if(Bluetooth_Data[0] == CALL_STARTED_ADDRES){
		Bluetooth_Data[0] = 0; // Degeri sifirla.
		Set_Address(0,0);
		for(uint16_t bit=0; bit<504; bit++){	
				Write_Data(phonecall[bit]);		
		}	
		Write_String_Language_Address(24, 0, "ARIYOR", 21, 0, "CALLING", Language);
		Set_Address(2, 5);
		Write_Char('+');
		for(uint8_t x = 2; x < 14; x++){
			Write_Char(Bluetooth_Data[x]);
		}
		Menu_Status = 0;
		Menu_Select_Status = 1;
		Menu_Call_Sms_Status = 1;
		Menu_Clock_Status = 0;	
			
			// Titresim aciksa.
		if(Vib_On_Off == 1){
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_SET);
			HAL_Delay(5000); // 5 saniye
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
		}
		else if(Vib_On_Off == 0){
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
		}
	}
	Bluetooth_Data[0] = 0;
}

void Call_Ended_Loop(void){
	HAL_UART_Receive(&huart1, (uint8_t *)Bluetooth_Data, 50, 1000);

	if(Bluetooth_Data[0] == CALL_ENDED_ADDRESS && Menu_Status == 0){
		Bluetooth_Data[0] = 0; // Degeri sifirla.
		Menu_Call_Sms_Status = 0;
		Menu_Clock_Status = 1;
		Menu_Status = 0;
		Menu_Select_Status = 1;
		HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); //Titresimi kapat.
		Clear_Display();
		Clock();
	}
	Bluetooth_Data[0] = 0;
}

void Sms_Loop(void){
	HAL_UART_Receive(&huart1, (uint8_t *)Bluetooth_Data, 50, 1000);
		// SMS geldiyse.
	if(Bluetooth_Data[0] == SMS_ADDRESS){
		Bluetooth_Data[0] = 0; // Degeri sifirla.
		Set_Address(0,0);
		for(uint16_t bit=0; bit<504; bit++){	
				Write_Data(phonecall[bit]);		
		}	
		Write_String_Language_Address(27, 0, "MESAJ", 21, 0, "MESSAGE", Language);
		Set_Address(2, 5);
		Write_Char('+');
		for(uint8_t x = 2; x < 14; x++){
			Write_Char(Bluetooth_Data[x]);
		}
		Menu_Status = 0;
		Menu_Select_Status = 1;
		Menu_Call_Sms_Status = 1;
		Menu_Clock_Status = 0;
		
			// Titresim aciksa.
		if(Vib_On_Off == 1){
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_SET);
			HAL_Delay(3000); // 3 saniye
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
		}
		else if(Vib_On_Off == 0){
			HAL_GPIO_WritePin(GPIOB, VIB_MOTOR_PIN, GPIO_PIN_RESET); 
		}		
	}
	Bluetooth_Data[0] = 0;
}


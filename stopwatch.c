// Header: STOPWATCH
// File Name: stopwatch.h
// Author: Mustafa Aslan
// Date: 4.11.2015

#include "stopwatch.h"

extern uint8_t Language;
extern TIM_HandleTypeDef htim3;

uint8_t Stopwatch_Start_Stop_Status ; // Kronometrenin durumu.

uint8_t stopwacth_minutes; // Kronometere dakika.
uint16_t stopwatch_miliseconds; // Kronomtre milisaniye.
uint8_t stopwatch_seconds; // Kronometre saniye.

// Kronometre dikdotgeni bitleri.
const unsigned char stopwatch_rectangle [] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x20, 0x20, 0x20, 0x20, 0x20,
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
0x20, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

void Stopwatch(void){
	Set_Address(0,0);
	Clear_Display();
		// Kronometredeki dikdortgeni.
	for(uint16_t bit=0; bit<504; bit++){	
		Write_Data(stopwatch_rectangle[bit]);		
	}	
			// Arkaplanda calisiyorken tekrar kronometre ekranina gelindiginde.
	if (Stopwatch_Start_Stop_Status == STOPWATCH_START){
		Write_String_Language_Address(24, 4, "DURDUR", 24, 4, " STOP ", Language);
	}
		// Uygulama ilk acildigi zaman.
	else{
		Write_String_Language_Address(18, 4, " BASLAT ", 27, 4, "START", Language);
		Stopwatch_Write(0, 0, 0);
			// Kronometre degerleri sifirlaniyor.
		stopwatch_miliseconds = 0;
		stopwatch_seconds = 0;
		stopwacth_minutes = 0;
		Stopwatch_Start_Stop_Status = STOPWATCH_WAITING;	// Kronometre bir sonraki sayim icin bekliyor.		
	} 

}

void Stopwatch_Ok_Button(void){
		// Kronometre bekliyorsa.
		// Bu fonksiyona girdiginde kronometre baslamis olacak.
	if(Stopwatch_Start_Stop_Status == STOPWATCH_WAITING){
		HAL_TIM_Base_Start_IT(&htim3); // Timer3 baslat.
		Write_String_Language_Address(24, 4, "DURDUR", 24, 4, " STOP ", Language);
		Stopwatch_Start_Stop_Status = STOPWATCH_START; // Kronometre basladi.
	}
		// Kronometre basladi ise.
		// Bu fonksiyona girildiginde kronometer durmus olacak.
	else if(Stopwatch_Start_Stop_Status == STOPWATCH_START){
		HAL_TIM_Base_Stop_IT(&htim3);	// Timer3 durdur.
		Write_String_Language_Address(21, 4, "TEMIZLE", 27, 4, "CLEAR", Language);
		Stopwatch_Start_Stop_Status = STOPWATCH_STOP; // Kronometre bitti
	}
		// Kronometer sayimi durdu ise.
		// Bu fonksiyona girdiginde kronometre degerleri sifirlacak.
		// Ve bir sonraki sayim icin bekleyecek.
	else if (Stopwatch_Start_Stop_Status == STOPWATCH_STOP){
		Write_String_Language_Address(18, 4, " BASLAT ", 27, 4, "START", Language);
		Stopwatch_Write(0, 0, 0);
		stopwatch_miliseconds = 0;
		stopwatch_seconds = 0;
		stopwacth_minutes = 0;
		Stopwatch_Start_Stop_Status = STOPWATCH_WAITING;	// Kronometer bekliyor.	
	}
}

void Stopwatch_Write(uint16_t miliseconds, uint8_t seconds, uint8_t minutes){
	Write_Two_Number(16, 2, minutes);
	Write_Char(':');
	Write_Two_Number(35, 2, seconds);
	Write_Char(':');
	Write_Two_Number(53, 2, miliseconds);	
}

void Stopwatch_Timer(uint8_t stopwatch_state){
		// Kronometer sayima baslamis ise.
	if(Stopwatch_Start_Stop_Status == STOPWATCH_START){			
		++stopwatch_miliseconds; // Timer her 10ms de stopwatch_miliseconds degerini bir arttiracak.		
			// stopwatch_miliseconds 99 ise.
		if(stopwatch_miliseconds == 99){
			stopwatch_miliseconds = 0; // stopwatch_miliseconds degerini sifirla.
			++stopwatch_seconds; // Saniye degerini bir arttir.
			stopwatch_seconds %= 60; 
		}	
		// stopwatch_seconds 59 ise.
		if(stopwatch_seconds == 59){
			++stopwacth_minutes; // Dakika degerini bir arttir.
			stopwatch_seconds = 0; // stopwatch_seconds degerini sifirla.
		}
	}
	 // Kronometre ekranda ise kronomtre sayi degerleri ekrana yazdirilacak.
	 // Fakat kronometre arkaplanda calisiyorsa sayi degerleri yazilmayacak.
	if(stopwatch_state == 1){
		Stopwatch_Write(stopwatch_miliseconds, stopwatch_seconds, stopwacth_minutes);	
	};
}



